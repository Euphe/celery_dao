# Celery. Этап 2: мой маленький RPC сервис.

Складывать числа это сложно, поэтому мы сделали API сервис, который реализует Remote Procedure Call.

* В `docker-compose` была добавлена БД `postgres`.
    * Она хранит информацию о "заданиях" и результатах их исполнения
    * Соединяется с другими сервисами через `links`
* `celery_dao` изменился
    * В `requirements.txt` и `Dockerfile` добавлены зависимости, необходимые для использования `postgres`
    * Взаимодействие с БД осуществляется через `sqlalchemy`
      * Структура БД описана в `models.py`
      * Везде используем `session API`, не забываем кэшировать сессии и закрывать их после обработки запроса 
    * Теперь имеет простой API на `flask`
      * `curl -X POST -F "a=1" -F "b=1" http://localhost:8000/calculate` отправит запрос на сложение 1 + 1. Вернет `task_id` запроса и ссылку, по которой можно получить результат.
      * `curl localhost:8000/task/<task_id>` вернет состояние запроса. Если задание в обработке, покажет, что статус задания "In processing". Если задание выполнилось, выведет результат в `result`.
    * `celery` worker теперь "кладет" результат выполнения запроса в БД, обновляя колонку `result` для соответствующего задания.
    * Ссылки для подключения к бд и `SERVER_NAME` передаются из `docker-compose`.  
      
